# Run Analysis: claude-sonnet-4.6 (Baseline — 3 runs)

- **Model**: anthropic/claude-sonnet-4.6 (Claude 4.6 Sonnet)
- **Provider**: OpenRouter
- **Date**: 2026-02-18
- **Runs analysed**: 3 CI dispatches, each producing a `default` and `no_guidelines` experiment

## Overall Scores

### With guidelines (default experiment)

| Run ID | Passed | Failed | Pass Rate |
|--------|--------|--------|-----------|
| `jn77xx97q6wgmphq2k2yw2h3dh81akt5` | 62 | 4 | 93.9% |
| `jn7e5atdqwnkjg20h9wbnnabtd81ax34` | 61 | 5 | 92.4% |
| `jn7576msjwqxebgwrf5kf77k0181a2cw` | 61 | 5 | 92.4% |

**Average with guidelines: 61.3/66 (92.9%)**

### Without guidelines (no_guidelines experiment)

| Run ID | Passed | Failed | Pass Rate |
|--------|--------|--------|-----------|
| `jn7f4n1m0sm4ec9shsm50vzevn81ar89` | 54 | 12 | 81.8% |
| `jn7a0wer4nj7spx7tws2p2gs5181adt4` | 56 | 10 | 84.8% |
| `jn75t46qdk5hbr1btqvd08er2981d2m7` | 54 | 12 | 81.8% |

**Average without guidelines: 54.7/66 (82.8%)**

## With-Guidelines Failure Summary

### Failure Frequency (across 3 runs)

| Eval | Category | Failed Step | Runs Failed | Classification |
|------|----------|-------------|-------------|----------------|
| 005-storage_http_action | 004-actions | deploy | 3/3 | KNOWN_GAP |
| 001-use_mutation | 006-clients | eslint | 3/3 | KNOWN_GAP |
| 006-no_storage | 003-mutations | deploy | 2/3 | MODEL_FAULT |
| 007-schema_evolution | 001-data_modeling | deploy | 2/3 | MODEL_FAULT |
| 018-pagination_returns_validator | 002-queries | deploy | 2/3 | MODEL_FAULT |
| 005-cascade_delete_nested | 003-mutations | deploy | 1/3 | MODEL_FAULT |
| 014-select_distinct | 002-queries | deploy | 1/3 | MODEL_FAULT |

### By step type

| Step | Count (total across 3 runs) |
|------|----|
| deploy (convex dev) | 11 |
| eslint | 3 |

## Per-Failure Analysis

### 1. 004-actions/005-storage_http_action — deploy (3/3 runs)

**Classification**: KNOWN_GAP

The task requires `process.env.CONVEX_SITE_URL!` for the `getSiteURL` query. The model implements this correctly. The failure is `Cannot find name 'process'` during `convex dev` typecheck because `@types/node` is not installed. The reference answer uses the same `process.env` pattern and would fail identically without `@types/node`. This is a known gap in the eval setup — the guidelines mention adding `@types/node` when using Node built-ins, but the task and reference answer don't include it in `package.json`. Previously documented in claude-opus-4-6 report.

**Model code (correct, same as reference):**
```typescript
export const getSiteURL = query({
  args: {},
  returns: v.string(),
  handler: async (_ctx, _args) => {
    return process.env.CONVEX_SITE_URL!;  // TS2580: Cannot find name 'process'
  },
});
```

---

### 2. 006-clients/001-use_mutation — eslint (3/3 runs)

**Classification**: KNOWN_GAP

Two issues combine: (1) `@typescript-eslint/no-misused-promises` fires on `<form onSubmit={handleSubmit}>` where `handleSubmit` is async — the `src.eslint.config.mjs` doesn't have the `checksVoidReturn: { attributes: false }` override that `eslint.config.mjs` has for `convex/`. (2) The model uses `React.FormEvent` without importing `React` (only imports `{ useState }` from react), causing `no-undef`.

The first issue is documented in GAPS.txt and the reference answer has the same async `onSubmit` pattern. The `React.FormEvent` issue is a minor model mistake but the primary failure is the lint config mismatch.

**Model code:**
```tsx
import { useState } from "react";  // No React import
const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => { ... };
return <form onSubmit={handleSubmit}>  // no-misused-promises
```

---

### 3. 003-mutations/006-no_storage — deploy (2/3 runs)

**Classification**: MODEL_FAULT

The model correctly identifies that `uploadFile` should be an `action` (not a mutation) for storage access, and correctly calls `ctx.runMutation(internal.index.storeFileMetadata, ...)` from the action. However, it exports `storeFileMetadata` as a public `mutation` instead of `internalMutation`. Since `internal.*` only includes functions registered with `internalMutation`/`internalQuery`/`internalAction`, the TypeScript type of `internal.index` is `{}`, causing `TS2339: Property 'index' does not exist on type '{}'`.

**Model code (wrong):**
```typescript
export const storeFileMetadata = mutation({  // Should be internalMutation
  args: { storageId: v.id("_storage"), fileName: v.string(), size: v.number() },
  handler: async (ctx, args) => { ... },
});
```

**Expected:**
```typescript
export const storeFileMetadata = internalMutation({
  args: { storageId: v.id("_storage"), fileName: v.string(), size: v.number() },
  handler: async (ctx, args) => { ... },
});
```

---

### 4. 001-data_modeling/007-schema_evolution — deploy (2/3 runs)

**Classification**: MODEL_FAULT

The model uses `v.undefined()` in the `getProduct` returns validator to represent the deprecated `category` field. Convex does not have a `v.undefined()` validator — `undefined` is not a valid Convex value. The correct approach is to simply omit the `category` field from the returns validator entirely.

**Model code (wrong):**
```typescript
returns: v.object({
  _id: v.id("products"),
  _creationTime: v.number(),
  name: v.string(),
  description: v.string(),
  category: v.undefined(),  // v.undefined() does not exist in Convex
  active: v.union(v.literal("active"), v.literal("inactive"), v.literal("banned")),
}),
```

**Expected:**
```typescript
returns: v.object({
  _id: v.id("products"),
  _creationTime: v.number(),
  name: v.string(),
  description: v.string(),
  active: v.union(v.literal("active"), v.literal("inactive"), v.literal("banned")),
}),
```

---

### 5. 002-queries/018-pagination_returns_validator — deploy (2/3 runs)

**Classification**: MODEL_FAULT

The model defines `splitCursor` as `v.union(v.string(), v.null())` in the returns validator, but Convex's `PaginationResult` type has `splitCursor` as `string | null | undefined` (it's optional). Similarly `pageStatus` can be `undefined`. The handler returns the raw `PaginationResult` from `.paginate()`, which may have `splitCursor` and `pageStatus` as `undefined`, causing a type incompatibility.

**Model code (wrong):**
```typescript
splitCursor: v.union(v.string(), v.null()),  // missing v.optional()
pageStatus: v.union(v.literal("SplitRecommended"), v.literal("SplitRequired"), v.null()),  // missing v.optional()
```

**Expected:**
```typescript
splitCursor: v.optional(v.union(v.string(), v.null())),
pageStatus: v.optional(v.union(v.literal("SplitRecommended"), v.literal("SplitRequired"), v.null())),
```

---

### 6. 003-mutations/005-cascade_delete_nested — deploy (1/3 runs)

**Classification**: MODEL_FAULT

The model attempted an optimization using `Promise.all` to interleave comment and like queries per post, then used invalid TypeScript type assertions (`ReturnType<typeof ctx.db.query<"comments">["collect"]>`) to re-separate them. `ctx.db.query` is not a generic function that can be subscripted at the type level, so this syntax causes `TS2339`.

**Model code (wrong):**
```typescript
const commentsOnPost = postDependents[i] as Awaited<
  ReturnType<typeof ctx.db.query<"comments">["collect"]>  // invalid TypeScript
>;
```

**Expected (simpler approach):**
```typescript
const comments = await ctx.db
  .query("comments")
  .withIndex("by_post", (q) => q.eq("postId", postId))
  .collect();
```

---

### 7. 002-queries/014-select_distinct — deploy (1/3 runs)

**Classification**: MODEL_FAULT

The model used a `while (true)` loop where `cursor` is reassigned from `nextDoc.age` and `nextDoc`'s type depends on `cursor`, creating a circular type inference chain. TypeScript falls back to implicit `any` (error under `strict: true`). The fix would be adding an explicit type annotation to `nextDoc`, or using the reference answer's pattern of storing a cursor of the document type.

**Model code (wrong):**
```typescript
let cursor: number | null = null;
while (true) {
  const nextDoc =  // TS7022: implicit 'any' due to circular inference
    cursor === null
      ? await ctx.db.query("users").withIndex("by_age").order("asc").first()
      : await ctx.db.query("users")
          .withIndex("by_age", (q) => q.gt("age", cursor as number))
          .order("asc").first();
  if (nextDoc === null) break;
  cursor = nextDoc.age;  // circular: cursor depends on nextDoc
}
```

---

## No-Guidelines Additional Failures

The no_guidelines experiment had significantly more failures (avg 10.7 vs 4.7). Additional failures not seen in with-guidelines:

| Eval | Category | Failed Step | Runs Failed (of 3) |
|------|----------|-------------|---------------------|
| 005-function_calling | 000-fundamentals | deploy | 3/3 |
| 006-node | 004-actions | deploy | 3/3 |
| 015-pagination | 002-queries | tests (86%) | 3/3 |
| 016-pagination_index | 002-queries | deploy | 2/3 |
| 013-async_iterator_filter | 002-queries | deploy | 2/3 |
| 005-cascade_delete_nested | 003-mutations | eslint | 2/3 |
| 003-mutation_schedule_action | 004-actions | eslint | 1/3 |
| 004-cascade_delete | 003-mutations | tests (83%) | 1/3 |
| 007-http_action_routing | 004-actions | deploy | 1/3 |

These are generally expected: without guidelines the model lacks Convex-specific knowledge about internal functions, `"use node"` directives, pagination patterns, etc.

## Cross-Cutting Patterns

### 1. Deploy failures dominate (11/14 with-guidelines failures)

Almost all failures are TypeScript / Convex type errors caught during `convex dev`. The model's code logic is usually correct, but it gets tripped up by Convex's type system nuances.

### 2. Two failures are entirely KNOWN_GAP (6/14 total occurrences)

`005-storage_http_action` and `001-use_mutation` fail 100% of the time across all 3 runs, but both are known eval setup issues:
- `@types/node` missing for `process.env`
- `no-misused-promises` lint config mismatch in `src.eslint.config.mjs`

If these were fixed, the with-guidelines pass rate would improve from **92.9% to 96.0%** (avg 63.3/66).

### 3. Convex-specific API patterns are the main model weakness

The genuine model faults cluster around:
- **Validators that don't exist**: `v.undefined()` (schema_evolution)
- **Optional vs required in pagination results**: `splitCursor`/`pageStatus` need `v.optional()` wrapping
- **`mutation` vs `internalMutation`**: When a function is called via `internal.*`, it must be registered with `internalMutation`
- **TypeScript type inference edge cases**: Circular inference, invalid generic type assertions

### 4. Guidelines provide ~10 percentage point improvement

With guidelines: 92.9% average. Without: 82.8% average. The 10pp delta shows the guidelines are effective, especially for Convex-specific patterns like internal functions, `"use node"`, and pagination.

### 5. Comparison to Claude Opus 4.6

Claude Opus 4.6 scored 55/66 (83.3%) with guidelines in its analysed run (jn72t14a), but that was before several eval/lint fixes were applied. Sonnet 4.6 at 92.9% with guidelines represents a strong baseline, especially considering the two known-gap failures inflate the failure count.

## Recommendations

### Eval improvements (would fix known gaps)
1. **005-storage_http_action**: Add `@types/node` to the eval's `package.json` devDependencies, or have the runner inject it for evals that use `process.env`
2. **001-use_mutation**: Add `checksVoidReturn: { attributes: false }` override to `src.eslint.config.mjs` to match `eslint.config.mjs`

### No action needed (genuine model faults)
3. **007-schema_evolution**: Model needs to learn that `v.undefined()` doesn't exist in Convex; omit deprecated fields from returns validators instead
4. **018-pagination_returns_validator**: Model needs to learn that `splitCursor` and `pageStatus` in pagination results can be `undefined` and need `v.optional()` wrapping
5. **006-no_storage**: Model needs to learn that functions called via `internal.*` must use `internalMutation`/`internalQuery`/`internalAction`
6. **005-cascade_delete_nested**: Model over-engineers with invalid TypeScript generics (1/3 runs, low frequency)
7. **014-select_distinct**: Model creates circular type inference (1/3 runs, low frequency)

## Net Impact

| Category | Count (unique evals) | Total occurrences across 3 runs |
|----------|--------|-----|
| KNOWN_GAP | 2 | 6 |
| MODEL_FAULT | 5 | 8 |

**Adjusted pass rate** (after fixing known gaps): ~96.0% with guidelines, ~85.9% without guidelines.
